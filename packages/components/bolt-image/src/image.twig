{# Data from Bolt Manifest #}
{% set imageDataBolt = bolt.data.images[src] %}
{# Data from processing image file #}
{% set imageDataTwig = getImageData(src)  %}
{#{% set imageData = imageDataBolt|merge(imageDataTwig) %}#}

{% set placeholderImage = imageDataTwig.base64 %}
{% set placeholderColor = imageDataTwig.color %}
{% set height = imageDataTwig.height %}
{% set width = imageDataTwig.width %}

{% set ratio = ratio ?? true %}
{% set sizes = sizes | default("auto") %}
{% set zoom = zoom ?? false %}
{% set lazyload = lazyload ?? true %}

{# Get a whole number aspect ratio #}
{#@todo This mutation of ratio is not clear, refactor#}
{% if width > 0 and height > 0 and ratio == true %}
  {% set ratio = height / width * 100 ~ '%' %}
{% endif %}


{% set ext = src|split('.')|last %}
{% set srcset = src %}
{% if imageData %}
  {% set srcset = imageData.srcset %}
{% endif %}

{% set zoomSource = src %}
{% set placeholderDummySrc = "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" %}

{#--------------------#}
{# STOP!!!!!!!!!#}
{# The ONLY thing that can happen below here is creating and building the `attributes`, then calling the template - ALL data must be prepped by this point #}
{#--------------------#}

{% set attributes = create_attribute(attributes | default({})).addClass('c-bolt-image') %}

{% set imageAttributes = create_attribute(imageAttributes | default({})).addClass([
  "c-bolt-image__img",
  lazyload ? "js-lazyload" : "",
  lazyload ? "is-lazyloading" : ""
])
  .setAttribute('alt', alt)
  .setAttribute('src', src)
%}

{% if srcset %}
  {% set imageAttributes = imageAttributes.setAttribute("srcset", srcset) %}
{% endif %}

{% if zoom %}
  {% set imageAttributes = imageAttributes
    .setAttribute("data-zoom", zoomSource) %}
{% endif %}

{% set placeholderAttributes = create_attribute(placeholderAttributes | default({})).addClass("c-bolt-image__placeholder") %}
{% set styles = placeholderAttributes.getAttribute('style') | split(' ') | merge([
  placeholderColor ? "background-color: #{placeholderColor};" : "",
  placeholderImage ? "background-image: url(#{placeholderImage});" : ""
]) %}
{% set placeholderAttributes = placeholderAttributes.setAttribute('style', styles) %}

{% if lazyload %}
  {% set imageAttributes = imageAttributes
    .setAttribute("data-srcset", srcset)
    .setAttribute("srcset", placeholderDummySrc)
    .setAttribute("data-sizes", sizes) %}
{% endif %}

{% set imageTag %}
  <img {{ imageAttributes }}>

{# Only output noscript fallback if lazyloading, and ratio will be output #}
  {% if lazyload and width > 0 and height > 0 and ratio == true %}
    <noscript>
      <img {{ imageAttributes.removeClass(["js-lazyload", "is-lazyloading"]) }}>
    </noscript>
  {% endif %}
{% endset %}

{% set imagePlaceholder %}
  <span {{ placeholderAttributes }}></span>
{% endset %}

{# Super helpful info if you uncomment #}
{{ console_log(_context) }}

<bolt-image>
  {% block image_content %}
    {% if width > 0 and height > 0 and ratio == true %}
      {% embed "@bolt/ratio.twig" with {
        attributes: attributes,
        aspectRatioHeight: height * 1,
        aspectRatioWidth: width * 1
      } %}
        {% block ratio_content %}
          {{ ext == "jpg" ? imagePlaceholder : "" }}
          {{ imageTag }}
        {% endblock %}
      {% endembed %}
    {% else %}
      {{ ext == "jpg" ? imagePlaceholder : "" }}
      {{ imageTag }}
    {% endif %}
  {% endblock %}
</bolt-image>
