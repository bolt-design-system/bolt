
{# 
  Bolt Image - Structure:
  - .c-bolt-image: uses the ratio object as a base if enabled
    - .c-bolt-image__img: lazyloaded img tag
    - .c-bolt-image__placeholder: lazyloader span while the img is lazyloaded.
#}

{% set srcset = srcset ?? "" %}
{% set lazyload = lazyload | default(true) %}
{% set placeholderColor = placeholderColor | default(bgcolor(src)) %}
{% set placeholderImage = placeholderImage | default(base64(src)) %}
{% set height = height | default(ratio(src, 'height')) %}
{% set width = width | default(ratio(src, 'width')) %}
{% set ratio = ratio | default(true) %}

{# Get a whole number aspect ratio #}
{% set gcd %}
  {% include '@bolt/_gcd.twig' with {
    a: width,
    b: height
  } only %}
{% endset %}
{% set gcd = gcd | escape %}
{% if gcd != 0 %}
  {% set imageHeightRatio = (height / gcd) | round %}
  {% set imageWidthRatio = (width / gcd) | round %}
{% else %}
  {% set imageHeightRatio = 1 %}
  {% set imageWidthRatio = 1 %}
{% endif %}

{% set ext = src|split('.')|last %}

{% set placeholderDummySrc = "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" %}

{# macro srcset(srcset, width, path, ext, sizes) #}
  {% if srcset == "" and ext != "svg" %}
    {% set path = publicpath(src|split('.' ~ ext)|first) %}
    {% set sizes = globalBoltImageSizes %}
    {% for size in sizes if (size <= width) %}
      {% if size == width %}
        {% set srcset = srcset ~ '../..' ~ path ~ '.' ~ ext ~ ' ' ~ size ~ 'w' ~ ', ' %}
      {% else %}
        {% set srcset = srcset ~ '../..' ~ path ~ '-' ~ size ~ '.' ~ ext ~ ' ' ~ size ~ 'w' ~ ', ' %}
      {% endif %}
    {% endfor %}
    {% set srcset = srcset|trim(', ') %}
  {% elseif ext == "svg" %}
    {% set srcset = src %}
  {% endif %}
{# endmacro #}
{# import _self as bolt #}

{# Main bolt-image component #}
{% set attributes = create_attribute(attributes | default([])).addClass('c-bolt-image') %}
{% set styles = attributes.getAttribute('style') | split(' ') | merge([
  "--aspect-ratio-h: #{height};",
  "--aspect-ratio-w: #{width};"
]) %}
{% set attributes = attributes.setAttribute('style', styles | join(' ')) %}

{# child img tag #}
{% set imgAttributes = create_attribute([]).addClass([
    "c-bolt-image__img",
    lazyload ? "js-lazyload" : "",
    lazyload ? "is-lazyloading" : ""
  ])
  .setAttribute('alt', alt)
%}

{% if lazyload %}
  {% set imgAttributes = imgAttributes
    .setAttribute("data-srcset", srcset)
    .setAttribute("srcset", placeholderDummySrc)
    .setAttribute("data-sizes", "auto")
  %}
{% else %}
  {% set imgAttributes = imgAttributes.setAttribute("srcset", srcset) %}
{% endif %}

{% set imgPlaceholderAttributes = create_attribute([]).addClass("c-bolt-image__placeholder") %}
{% set styles = imgPlaceholderAttributes.getAttribute('style') | split(' ') | merge([
    placeholderColor ? "background-color: #{placeholderColor};" : "",
    placeholderImage ? "background-image: url(#{placeholderImage});" : ""
  ])
%}
{% set imgPlaceholderAttributes = imgPlaceholderAttributes.setAttribute('style', styles) %}

{% set imageTag %}
  <img {{ imgAttributes }}>
  <noscript>
    <img {{ imgAttributes.removeClass(["js-lazyload", "is-lazyloading"]).setAttribute("srcset", srcset) }}>
  </noscript>
{% endset %}

{% set imagePlaceholder %}
  <span {{ imgPlaceholderAttributes }}></span>
{% endset %}
<bolt-image>
  {% block image_content %}
    {% if ratio == true %}
      {% embed "@bolt/ratio.twig" with {
        attributes: attributes
      } %}
        {% block ratio_content %}
          {{ imagePlaceholder }}
          {{ imageTag }}
        {% endblock %}
      {% endembed %}
    {% else %}
      {{ imagePlaceholder }}
      {{ imageTag }}
    {% endif %}
  {% endblock %}
</bolt-image>
