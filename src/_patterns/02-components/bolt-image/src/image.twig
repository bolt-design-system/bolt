
{# 
  Bolt Image - Structure:
  - .c-bolt-image: uses the ratio object as a base if enabled
    - .c-bolt-image__img: lazyloaded img tag
    - .c-bolt-image__placeholder: lazyloader span while the img is lazyloaded.
#}




{% set srcset = srcset ?? "" %}
{% set shouldLazyload = lazyload | default(true) %}

{% set sizes = globalBoltImageSizes %}
{% set ext = src|split('.')|last %}
{% set path = publicpath(src|split('.' ~ ext)|first) %}

{% set placeholderDummySrc = "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" %}

{% set placeholderColor = bgcolor(src) %}
{% set placeholderImage = base64(src) %}

{% set imageHeightRatio = ratio(src, 'height') %}
{% set imageWidthRatio = ratio(src, 'width') %}
{% set imageWidth = imagesize(src) %}

{# By default, include a ratio unless set to false #}
{% set ratio = ratio is defined and ratio == false ? false : true %}

{# macro srcset(srcset, imageWidth, path, ext, sizes) #}
  {% if srcset == "" and ext != "svg" %}
    {% for size in sizes if (size <= imageWidth) %}
      {% if size == imageWidth %}
        {% set srcset = srcset ~ '../..' ~ path ~ '.' ~ ext ~ ' ' ~ size ~ 'w' ~ ', ' %}
      {% else %}
        {% set srcset = srcset ~ '../..' ~ path ~ '-' ~ size ~ '.' ~ ext ~ ' ' ~ size ~ 'w' ~ ', ' %}
      {% endif %}
    {% endfor %}
    {% set srcset = srcset|trim(', ') %}
  {% elseif ext == "svg" %}
    {% set srcset = src %}
  {% endif %}
{# endmacro #}
{# import _self as bolt #}

{# Main bolt-image component #}
{% set imageAttributes = create_attribute({
  class: [
    "c-bolt-image"
  ],
  style: [
    "--aspect-ratio-h: #{imageHeightRatio};",
    "--aspect-ratio-w: #{imageWidthRatio};"
  ]
}) %}



{# child img tag #}
{% set imgTagAttributes = deep_merge({
  class: [
    "c-bolt-image__img",
    shouldLazyload ? "js-lazyload" : "",
    shouldLazyload ? "is-lazyloading" : ""
  ],
  alt: alt ?? ""
}, attributes | default({})) %}
{% set imgTagAttributes = create_attribute(imgTagAttributes) %}


{% if shouldLazyload %}
  {% set imgTagAttributes = imgTagAttributes.setAttribute("data-srcset", srcset).setAttribute("srcset", placeholderDummySrc).setAttribute("data-sizes", "auto") %}
{% else %}
  {% set imgTagAttributes = imgTagAttributes.setAttribute("srcset", srcset) %}
{% endif %}




{% set imgPlaceholderAttributes = deep_merge({
  class: [
    "c-bolt-image__placeholder"
  ],
  style: [
    placeholderColor ? "background-color: #{placeholderColor};" : "",
    placeholderImage ? "background-image: url(#{placeholderImage});" : ""
  ]
}, attributes | default({})) %}
{% set imgPlaceholderAttributes = create_attribute(imgPlaceholderAttributes) %}


{% set imageTag %}
  <img {{ imgTagAttributes }}>
  <noscript>
    <img {{ imgTagAttributes.removeClass(["js-lazyload", "is-lazyloading"]).setAttribute("srcset", srcset) }}>
  </noscript>
{% endset %}

{% set imagePlaceholder %}
  <span {{ imgPlaceholderAttributes }}></span>
{% endset %}

<bolt-image>
  {% block image_content %}
    {% if ratio == true %}
      {% embed "@bolt/ratio.twig" with {
        attributes: imageAttributes
      } %}
        {% block ratio_content %}
          {{ imagePlaceholder }}
          {{ imageTag }}
        {% endblock %}
      {% endembed %}
    {% else %}
      {{ imagePlaceholder }}
      {{ imageTag }}
    {% endif %}
  {% endblock %}
</bolt-image>
